---
import BaseLayout from './BaseLayout.astro';
import Badge from '@components/Badge.astro';
import FormattedDate from '@components/FormattedDate.astro';
import { slugify } from '@lib/posts';
import { CldImage } from 'astro-cloudinary';
import type { CollectionEntry } from 'astro:content';
import { SITE_TITLE } from 'src/consts';
import { cn } from '@lib/utils';
import Prose from '@components/Prose.astro';

type Props = CollectionEntry<'blog'>['data'] & {
  next?: CollectionEntry<'blog'>;
  prev?: CollectionEntry<'blog'>;
  slug?: string;
};

const {
  title,
  description = '',
  date,
  lastmod,
  cover,
  excerpt,
  tags,
  categories,
  next,
  prev,
  slug,
} = Astro.props;

// generate structured data for SEO
// ensure slug exists to prevent errors
if (!slug) {
  throw new Error('BlogPost component requires a slug prop');
}
const canonicalUrl = new URL(`/blog/${slug}/`, Astro.site);
const imageUrl = cover
  ? cover.startsWith('http')
    ? cover
    : `https://res.cloudinary.com/joelmturner/image/upload/${cover}`
  : `${Astro.site}/favicon-32x32.png`;

// generate structured data with safe defaults to prevent errors
const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: title || '',
  description: (excerpt || description || '').substring(0, 500),
  ...(date && { datePublished: date.toISOString() }),
  ...(lastmod || date ? { dateModified: (lastmod || date).toISOString() } : {}),
  author: {
    '@type': 'Person',
    name: SITE_TITLE,
    url: Astro.site?.toString() || '',
  },
  publisher: {
    '@type': 'Organization',
    name: SITE_TITLE,
    logo: {
      '@type': 'ImageObject',
      url: `${Astro.site}/favicon-32x32.png`,
    },
  },
  mainEntityOfPage: {
    '@type': 'WebPage',
    '@id': canonicalUrl.toString(),
  },
  ...(tags && tags.length > 0 && { keywords: tags.join(', ') }),
  ...(categories && { articleSection: categories }),
  ...(cover
    ? {
        image: {
          '@type': 'ImageObject',
          url: imageUrl,
          width: 1200,
          height: 630,
        },
      }
    : {
        image: imageUrl,
      }),
};
---

<BaseLayout title={title} description={excerpt ?? description} image={cover}>
  <script is:inline type="application/ld+json" set:html={JSON.stringify(structuredData, null, 0)} />
  <script define:vars={{ pageTitle: title, pageUrl: Astro.url.href }}>
    function shareOnFacebook() {
      window.open(
        'https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(pageUrl),
        'facebook-share-dialog',
        'width=626,height=436'
      );
    }

    function shareOnBluesky() {
      const text = encodeURIComponent(pageTitle + ' ' + pageUrl);
      window.open(
        'https://bsky.app/intent/compose?text=' + text,
        'bluesky-share-dialog',
        'width=626,height=436'
      );
    }

    function shareOnLinkedIn() {
      window.open(
        'https://www.linkedin.com/shareArticle?url=' + encodeURIComponent(pageUrl),
        'linkedin-share-dialog',
        'width=626,height=436'
      );
    }

    function shareOnEmail() {
      window.open(
        'mailto:?subject=' + encodeURIComponent(pageTitle) + '&body=' + encodeURIComponent(pageUrl),
        'email-share-dialog',
        'width=626,height=436'
      );
    }

    // attach event listeners after DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      const facebookBtn = document.querySelector('[data-share="facebook"]');
      const blueskyBtn = document.querySelector('[data-share="bluesky"]');
      const linkedinBtn = document.querySelector('[data-share="linkedin"]');
      const emailBtn = document.querySelector('[data-share="email"]');

      if (facebookBtn) facebookBtn.addEventListener('click', shareOnFacebook);
      if (blueskyBtn) blueskyBtn.addEventListener('click', shareOnBluesky);
      if (linkedinBtn) linkedinBtn.addEventListener('click', shareOnLinkedIn);
      if (emailBtn) emailBtn.addEventListener('click', shareOnEmail);
    });
  </script>
  <div class="mx-auto">
    {
      cover && (
        <CldImage
          width={770}
          height={415}
          src={cover}
          alt={title}
          class={cn('max-w-[90vw] lg:max-w-[3xl] rounded-xl shadow-lg')}
          sizes="(max-width: 360px) 240px, (max-width: 720px) 540px, (max-width: 1600px) 720px, 770px"
          loading="eager"
          fetchpriority="high"
          dpr="2.0"
          crop="fill"
          gravity="center"
          quality="auto"
        />
      )
    }
  </div>
  <div class="p-3">
    <div class="py-2 text-center line-height-1">
      <div class="mb-2 text-slate-500 dark:text-slate-400">
        {!!date && <FormattedDate date={date} />}
        {
          lastmod && (
            <div class="text-slate-500 dark:text-slate-400 font-italic">
              Last updated on <FormattedDate date={lastmod} />
            </div>
          )
        }
      </div>
      <h1 class="text-2xl lg:text-4xl">
        {title}
      </h1>
      <hr class="my-4 border-slate-700" />
    </div>
    <Prose>
      <article>
        <slot />
      </article>
    </Prose>
  </div>

  <wa-divider style="--spacing: 2rem;"></wa-divider>

  <section class="flex flex-col gap-3">
    <div class="flex gap-3 items-center">
      Category: <Badge link={`/blog/category/${slugify(categories)}/`}>
        {categories}
      </Badge>
    </div>
    <div class="flex gap-3 items-center flex-wrap">
      Tags: {tags.map((tag) => <Badge link={`/blog/tag/${slugify(tag)}/`}>{tag}</Badge>)}
    </div>

    <div class="flex gap-2 flex-wrap items-center">
      <span class="text-lg font-bold">Share this post</span>
      <span class="flex items-center">
        <wa-button variant="neutral" appearance="plain" data-share="facebook">
          <wa-icon name="facebook" family="brands" label="Share on Facebook"></wa-icon>
          Facebook
        </wa-button>
      </span>
      <span class="flex items-center">
        <wa-button variant="neutral" appearance="plain" data-share="bluesky">
          <wa-icon name="bluesky" family="brands" label="Share on Bluesky"></wa-icon>
          Bluesky
        </wa-button>
      </span>
      <span class="flex items-center">
        <wa-button variant="neutral" appearance="plain" data-share="linkedin">
          <wa-icon name="linkedin" family="brands" label="Share on LinkedIn"></wa-icon>
          LinkedIn
        </wa-button>
      </span>
      <span class="flex items-center">
        <wa-button variant="neutral" appearance="plain" data-share="email">
          <wa-icon name="envelope-open" label="Share with email"></wa-icon>
          Email
        </wa-button>
      </span>
    </div>

    <wa-divider style="--spacing: 2rem;"></wa-divider>

    <div class="flex justify-between p-3 gap-8 text-accent">
      {
        prev?.data?.slug && (
          <a
            href={`/blog/${prev?.data?.slug}/`}
            class="flex gap-2 items-center transition-color duration-200 hover:text-brand-300 dark:hover:text-brand-400"
          >
            <span>{`< `}</span> {prev?.data?.title}
          </a>
        )
      }
      {
        next?.data?.slug && (
          <a
            href={`/blog/${next?.data?.slug}/`}
            class="flex gap-2 items-center transition-color duration-200 hover:text-brand-300 dark:hover:text-brand-400"
          >
            {next?.data?.title} <span>{` >`}</span>
          </a>
        )
      }
    </div>
  </section>
</BaseLayout>

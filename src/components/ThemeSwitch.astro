---
import { cn } from '@lib/utils';

const themeIconStyles = cn(
  'w-6 h-6 py-1 px-1 text-accent cursor-pointer hover:text-gray-700 dark:hover:text-gray-300 active:text-gray-800 dark:active:text-gray-700'
);
---

<div
  class={cn(
    'flex gap-1 items-center rounded-md bg-orange-100 dark:bg-slate-700 h-6 overflow-hidden',
    '*:data-theme-value:bg-transparent *:data-theme-value:transition-colors *:data-theme-value:duration-200',
    '[&>[data-theme-value="light"].active]:bg-brand-200',
    '[&>[data-theme-value="system"].active]:bg-brand-200',
    '[&>[data-theme-value="dark"].active]:bg-brand-200 [&>[data-theme-value="dark"].active]:text-blue-900',
    'theme-switch max-h-[120px]'
  )}
  style="display: flex; gap: 0.25rem; align-items: center; height: 1.5rem; overflow: hidden;"
>
  <svg
    data-theme-value="light"
    xmlns="http://www.w3.org/2000/svg"
    fill="none"
    viewBox="0 0 24 24"
    stroke-width="1.5"
    stroke="currentColor"
    width="24"
    height="24"
    class={themeIconStyles}
    style="width: 1.5rem; height: 1.5rem; padding: 0.25rem; cursor: pointer;"
  >
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"
    ></path>
  </svg>

  <svg
    data-theme-value="system"
    xmlns="http://www.w3.org/2000/svg"
    fill="none"
    viewBox="0 0 24 24"
    stroke-width="1.5"
    stroke="currentColor"
    width="24"
    height="24"
    class={themeIconStyles}
    style="width: 1.5rem; height: 1.5rem; padding: 0.25rem; cursor: pointer;"
  >
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      d="M21 7.5l-2.25-1.313M21 7.5v2.25m0-2.25l-2.25 1.313M3 7.5l2.25-1.313M3 7.5l2.25 1.313M3 7.5v2.25m9 3l2.25-1.313M12 12.75l-2.25-1.313M12 12.75V15m0 6.75l2.25-1.313M12 21.75V19.5m0 2.25l-2.25-1.313m0-16.875L12 2.25l2.25 1.313M21 14.25v2.25l-2.25 1.313m-13.5 0L3 16.5v-2.25"
    ></path>
  </svg>

  <svg
    data-theme-value="dark"
    xmlns="http://www.w3.org/2000/svg"
    fill="none"
    viewBox="0 0 24 24"
    stroke-width="1.5"
    stroke="currentColor"
    width="24"
    height="24"
    class={themeIconStyles}
    style="width: 1.5rem; height: 1.5rem; padding: 0.25rem; cursor: pointer;"
  >
    <path
      stroke-linecap="round"
      stroke-linejoin="round"
      d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z"
    ></path>
  </svg>
</div>

<style>
  :global(.dark) {
    data-color-mode: dark;
  }

  /* prevent FOUC by ensuring component is styled before Tailwind loads */
  .theme-switch {
    display: flex;
    gap: 0.25rem;
    align-items: center;
    height: 1.5rem;
    overflow: hidden;
    border-radius: 0.375rem;
  }

  .theme-switch svg {
    width: 1.5rem;
    height: 1.5rem;
    padding: 0.25rem;
    cursor: pointer;
    flex-shrink: 0;
  }
</style>

<script is:inline>
  function getSystemTheme() {
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function updateTheme(value) {
    const systemTheme = getSystemTheme();
    const theme = value === 'system' ? systemTheme : value;

    // set the value on root
    document.documentElement.setAttribute(`data-color-mode`, theme);

    // set or remove wa-dark class based on theme
    if (theme === 'dark') {
      document.documentElement.classList.add('wa-dark');
    } else {
      document.documentElement.classList.remove('wa-dark');
    }

    // set the active class on the active mode icon in all theme switches
    document.querySelectorAll(`[data-theme-value="${value}"]`).forEach((el) => {
      el.classList.add('active');
    });

    // update the logo based on mode
    const logosByTheme = {
      light: `https://res.cloudinary.com/joelmturner/image/upload/f_auto,q_auto/v1673573341/jmt-logo-light-500w_2_pmadzj.png`,
      dark: `https://res.cloudinary.com/joelmturner/image/upload/f_auto,q_auto/v1673573341/jmt-logo-dark-500w_2_pxay5e.png`,
    };
    document.querySelector(`[data-logo]`)?.setAttribute('src', logosByTheme[theme]);

    localStorage.setItem('theme', value);
  }

  function initializeTheme() {
    const theme = localStorage.getItem('theme');
    const systemTheme = getSystemTheme();
    const baseValue = theme !== null ? theme : systemTheme;

    // resolve the actual theme value
    const resolvedTheme = baseValue === 'system' ? systemTheme : baseValue;
    const currentMode = document.documentElement.getAttribute('data-color-mode');
    const currentWaDark = document.documentElement.classList.contains('wa-dark');

    // only update theme attributes/classes if they've changed to prevent flashes
    if (currentMode !== resolvedTheme || (resolvedTheme === 'dark') !== currentWaDark) {
      updateTheme(baseValue);
    } else {
      // theme is already correct, just update UI elements without touching html classes
      // clear all active classes first
      document.querySelectorAll('[data-theme-value]').forEach((el) => {
        el.classList.remove('active');
      });

      // set active classes
      document.querySelectorAll(`[data-theme-value="${baseValue}"]`).forEach((el) => {
        el.classList.add('active');
      });

      // update the logo based on current mode
      const logosByTheme = {
        light: `https://res.cloudinary.com/joelmturner/image/upload/f_auto,q_auto/v1673573341/jmt-logo-light-500w_2_pmadzj.png`,
        dark: `https://res.cloudinary.com/joelmturner/image/upload/f_auto,q_auto/v1673573341/jmt-logo-dark-500w_2_pxay5e.png`,
      };
      document.querySelector(`[data-logo]`)?.setAttribute('src', logosByTheme[resolvedTheme]);
    }
  }

  function attachClickHandler() {
    // find all theme switches and attach handlers to each
    const themeSwitches = document.querySelectorAll('.theme-switch');
    themeSwitches.forEach((themeSwitch) => {
      // skip if handler already attached
      if (themeSwitch.dataset.handlerAttached === 'true') return;

      // mark as attached to prevent duplicates
      themeSwitch.dataset.handlerAttached = 'true';

      // use event delegation to handle clicks (works even if element is replaced)
      themeSwitch.addEventListener('click', (event) => {
        const selected = event.target;
        const themeValue = selected.closest('[data-theme-value]');
        if (!themeValue) return;

        // clear all active classes in all theme switches
        document.querySelectorAll('.theme-switch svg').forEach((svg) => {
          svg.classList.remove('active');
        });

        // update theme with the selected value
        const value = themeValue.getAttribute('data-theme-value') ?? 'dark';
        updateTheme(value);
      });
    });
  }

  // initialize theme and handlers on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initializeTheme();
      attachClickHandler();
    });
  } else {
    initializeTheme();
    attachClickHandler();
  }
</script>

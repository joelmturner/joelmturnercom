---
import { type IllustrationItem } from '@lib/types';
import { css } from 'styled-system/css';
import { grid } from 'styled-system/patterns';
import { CldImage } from 'astro-cloudinary';
import { ILLUSTRATION_FILTER_OPTIONS } from '@lib/constants';
import { flex } from 'styled-system/patterns/flex';

// Add this function to get the Cloudinary public ID from the full URL
function getPublicId(url: string) {
  const parts = url.split('/');
  return parts.slice(-2).join('/').split('.')[0];
}

interface Props {
  illustrations: IllustrationItem[];
}

const { illustrations } = Astro.props;
---

<div class={flex({ gap: 4, flexDirection: 'column' })}>
  <div class={flex({ gap: 2, alignItems: 'center' })}>
    <wa-dropdown id="collection-select">
      <wa-button slot="trigger" with-caret>Collections</wa-button>

      {
        ILLUSTRATION_FILTER_OPTIONS.map(({ value, label }) => (
          <wa-dropdown-item value={value}>{label}</wa-dropdown-item>
        ))
      }
    </wa-dropdown>
  </div>

  <div id="gallery" class={grid({ columns: [1, 1, 2, 3], gap: 4 })}>
    {
      illustrations.map((image, index) => (
        <CldImage
          src={image.url}
          alt={image.id}
          width={400}
          height={400}
          loading="lazy"
          class={css({
            w: 'full',
            h: 'auto',
            objectFit: 'cover',
            borderRadius: 'md',
            cursor: 'pointer',
          })}
          data-tags={image.tags.join(',')}
          data-index={index}
          data-public-id={getPublicId(image.url)}
        />
      ))
    }
  </div>
</div>

<wa-dialog
  label="Dialog"
  light-dismiss
  class="dialog-light-dismiss"
  class={css({
    '--width': '70vw',
  })}
>
  <wa-carousel navigation style={{ '--aspect-ratio': '1/1' }}> </wa-carousel>
</wa-dialog>

<script>
  import { ILLUSTRATION_FILTER_OPTIONS } from '@lib/constants';
  import { getCldImageUrl } from 'astro-cloudinary/helpers';

  // Get the initial collection from the URL
  const urlParams = new URLSearchParams(window.location.search);
  const initialCollection = urlParams.get('collection') || 'joelmturner_featured';

  const select = document.querySelector('wa-dropdown');
  const dropdownButton = document.querySelector('wa-button');
  const gallery = document.getElementById('gallery');
  const carousel = document.querySelector('wa-carousel') as WaCarousel;
  const lightbox = document.querySelector('wa-dialog') as HTMLDialogElement;

  function filterImages(selectedValue: string) {
    const images = gallery?.getElementsByTagName('img');
    const resolvedSelectedValue =
      selectedValue === 'featured' ? 'joelmturner_featured' : selectedValue;
    for (const img of images ?? []) {
      if (img.dataset.tags?.includes(resolvedSelectedValue)) {
        img.style.display = 'block';
      } else {
        img.style.display = 'none';
      }
    }

    function getFullSizeUrl(publicId: string) {
      return decodeURIComponent(
        getCldImageUrl({
          src: publicId,
          width: 800,
          height: 800,
          format: 'auto',
          quality: 'auto',
        })
      );
    }

    // update the wa-carousel list based on the selected collection value
    carousel.innerHTML = '';
    Array.from(images ?? [])
      ?.filter((imageNode) => imageNode.dataset.tags?.includes(resolvedSelectedValue))
      ?.forEach((image) => {
        const slide = document.createElement('wa-carousel-item');
        slide.dataset.index = image.dataset.index;
        slide.dataset.publicId = image.dataset.publicId;
        slide.dataset.tags = image.dataset.tags;
        slide.innerHTML = `
        <img
          src="${getFullSizeUrl(image.dataset.publicId ?? '')}"
          alt="${image.id}"
          width="900"
          height="1200"
          sizes="70vw"
          data-index="${image.dataset.index}"
          data-public-id="${image.dataset.publicId}"
          data-tags="${image.dataset.tags}"
        />
    `;
        carousel.appendChild(slide);
      });
  }

  function updateSelectAndFilter(selectedValue: string, selectedLabel: string) {
    if (dropdownButton) {
      dropdownButton.textContent = selectedLabel;
    }
    filterImages(selectedValue);
  }

  interface WaSelectEvent extends Event {
    detail: {
      item: {
        value: string;
        textContent: string;
      };
    };
  }
  interface WaCarousel extends HTMLElement {
    goToSlide: (index: number) => void;
    currentIndex?: number;
  }

  // function to update URL parameter based on currently visible slide
  function updateUrlFromActiveSlide(publicId: string) {
    if (!publicId) return;

    const url = new URL(window.location.href);
    url.searchParams.set('image', publicId);
    window.history.pushState({}, '', url);
  }

  // handle carousel slide changes
  function handleCarouselSlideChange(event: Event) {
    if (!lightbox.open || !carousel) return;

    // get the current slide index from the event
    const slideChangeEvent = event as CustomEvent;
    const currentIndex = (slideChangeEvent.detail?.index ?? slideChangeEvent.detail ?? 0) as number;

    // find the carousel item at this index
    const carouselItems = Array.from(
      carousel.querySelectorAll('wa-carousel-item')
    ) as HTMLElement[];
    const currentItem = carouselItems[currentIndex];

    if (currentItem?.dataset.publicId) {
      const currentImageParam = new URLSearchParams(window.location.search).get('image');
      // only update if it's different from the current URL parameter
      if (currentImageParam !== currentItem.dataset.publicId) {
        updateUrlFromActiveSlide(currentItem.dataset.publicId);
      }
    }
  }

  select?.addEventListener('wa-select', function (event) {
    const customEvent = event as WaSelectEvent;
    const selectedValue = customEvent.detail.item.value;
    const selectedLabel = customEvent.detail.item.textContent;

    updateSelectAndFilter(selectedValue, selectedLabel);
    // Update URL with the new collection
    const url = new URL(window.location.href);
    url.searchParams.set('collection', selectedValue);
    window.history.pushState({}, '', url);
  });

  // function to open lightbox for a specific image by publicId
  function openLightboxForImage(publicId: string) {
    if (!publicId || window.innerWidth < 768) return;

    const images = gallery?.getElementsByTagName('img');
    const targetImage = Array.from(images ?? []).find((img) => img.dataset.publicId === publicId);

    if (targetImage) {
      lightbox.open = true;

      const carouselIndex = Array.from(carousel?.querySelectorAll(`wa-carousel-item`)).findIndex(
        (item) => (item as HTMLElement).dataset.publicId === publicId
      );

      (lightbox as HTMLDialogElement & { updateComplete: Promise<void> }).updateComplete.then(
        () => {
          if (carousel && carouselIndex !== -1) {
            if (carouselTimeout) {
              clearTimeout(carouselTimeout);
            }

            carouselTimeout = setTimeout(() => {
              carousel.goToSlide(carouselIndex);
            }, 100);
          }
        }
      );
    }
  }

  // initial update and filter based on the query parameter
  document.addEventListener('DOMContentLoaded', () => {
    const initialLabel =
      ILLUSTRATION_FILTER_OPTIONS.find((option) => option.value === initialCollection)?.label ??
      initialCollection;
    updateSelectAndFilter(initialCollection, initialLabel);

    // check if there's an image parameter in the URL and open lightbox
    const initialImage = urlParams.get('image');
    if (initialImage) {
      // wait for the carousel to be populated after filtering
      setTimeout(() => {
        openLightboxForImage(initialImage);
      }, 100);
    }

    // listen for carousel slide changes to update URL parameter
    carousel?.addEventListener('wa-slide-change', handleCarouselSlideChange);
  });

  let carouselTimeout: NodeJS.Timeout;

  gallery?.addEventListener('click', (event) => {
    const target = event.target as HTMLImageElement;
    if (target.tagName === 'IMG' && window.innerWidth >= 768) {
      const publicId = target.dataset.publicId;
      if (publicId) {
        // update URL with the image parameter
        const url = new URL(window.location.href);
        url.searchParams.set('image', publicId);
        window.history.pushState({}, '', url);
      }

      lightbox.open = true;

      const carouselIndex = Array.from(carousel?.querySelectorAll(`wa-carousel-item`)).findIndex(
        (item) => (item as HTMLElement).dataset.publicId === target.dataset.publicId
      );

      (lightbox as HTMLDialogElement & { updateComplete: Promise<void> }).updateComplete.then(
        () => {
          if (carousel) {
            if (carouselTimeout) {
              clearTimeout(carouselTimeout);
            }

            carouselTimeout = setTimeout(() => {
              carousel.goToSlide(carouselIndex);
            }, 100);
          }
        }
      );
    }
  });

  lightbox.addEventListener('click', (event) => {
    if (event.target === lightbox) {
      lightbox.open = false;
      // remove image parameter from URL when closing lightbox
      const url = new URL(window.location.href);
      url.searchParams.delete('image');
      window.history.pushState({}, '', url);
    }
  });

  // handle browser back/forward navigation
  window.addEventListener('popstate', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const imageParam = urlParams.get('image');

    if (imageParam) {
      // if image parameter exists, open lightbox
      setTimeout(() => {
        openLightboxForImage(imageParam);
      }, 100);
    } else {
      // if image parameter is removed, close lightbox
      if (lightbox.open) {
        lightbox.open = false;
      }
    }
  });
</script>

---
import ZineCard from '@components/ZineCard.astro';
import ZineFoldInstructions from '@components/ZineFoldInstructions.astro';
import BaseLayout from '@layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { css } from 'styled-system/css';
import { flex, grid } from 'styled-system/patterns';

const zines = await getCollection('zines');
---

<BaseLayout title={'Zines'} description={'Some illustrative zines'}>
  <div class={flex({ justify: 'space-between', alignItems: 'center', mb: 8 })}>
    <h1>Illustrated zines</h1>
    <a
      href="/illustration/"
      class={css({ textDecoration: 'underline', color: 'prose.link', textAlign: 'right' })}
      >‚Üê Back to Illustrations</a
    >
  </div>

  <div class={flex({ gap: 2 })}>
    <wa-button id="download-all-zines" size="small">Download all PDFs</wa-button>
    <ZineFoldInstructions />
  </div>

  <div
    class={grid({
      alignItems: 'center',
      maxWidth: '100%',
      direction: 'column',
      gap: 8,
      gridTemplateColumns: { sm: '1fr', lg: '1fr 1fr' },
      height: '100%',
      paddingBottom: 120,
    })}
  >
    {zines.map((zine) => <ZineCard zine={zine} />)}
  </div>
</BaseLayout>

<script>
  function initDownloadButton() {
    const downloadButton = document.getElementById('download-all-zines');
    if (!downloadButton) {
      console.error('Download button not found');
      return;
    }

    downloadButton.addEventListener('click', async () => {
      const button = downloadButton as HTMLElement & { disabled?: boolean };

      // disable button and show loading state
      if (button.disabled !== undefined) {
        button.disabled = true;
      }
      const originalText = button.textContent;
      button.textContent = 'Downloading...';

      try {
        console.log('Fetching zip file from API...');
        // try with trailing slash first (Astro default)
        let apiPath = '/api/zines/download-all/';
        let response = await fetch(apiPath);

        // if that fails, try without trailing slash
        if (!response.ok && response.status === 404) {
          console.log('Trying without trailing slash...');
          apiPath = '/api/zines/download-all';
          response = await fetch(apiPath);
        }

        if (!response.ok) {
          // try to get error message from response
          let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
          try {
            const errorData = await response.json();
            if (errorData.error) {
              errorMessage = errorData.error;
              if (errorData.details) {
                console.error('Error details:', errorData.details);
              }
            }
          } catch {
            // if response isn't JSON, use the status text
          }
          throw new Error(errorMessage);
        }

        const contentType = response.headers.get('content-type');
        console.log('Response Content-Type:', contentType);

        // check if response is actually a zip file
        if (contentType && !contentType.includes('application/zip')) {
          // might be an error response
          const text = await response.text();
          try {
            const errorData = JSON.parse(text);
            throw new Error(errorData.error || 'Unexpected response format');
          } catch {
            throw new Error('Server returned an error');
          }
        }

        const blob = await response.blob();
        console.log(`Received zip file: ${blob.size} bytes`);

        if (blob.size === 0) {
          throw new Error('Received empty zip file');
        }

        // trigger download
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'zines.zip';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        console.log('Zip file downloaded');
      } catch (error) {
        console.error('Error downloading zip:', error);
        const errorMessage = error instanceof Error ? error.message : 'Unknown error';
        alert(
          `Failed to download zip file: ${errorMessage}. Please check the browser console for details.`
        );
      } finally {
        // restore button state
        if (button.disabled !== undefined) {
          button.disabled = false;
        }
        button.textContent = originalText;
      }
    });
  }

  // wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDownloadButton);
  } else {
    initDownloadButton();
  }
</script>
